doctype html
html
  head
    title PetroMath:#{title}
    - var mobileReadyPages = ['Shift Closing', 'Login', 'Select Location']
    if mobileReadyPages.includes(title)
      meta(name="viewport" content="width=device-width, initial-scale=1.0")   
    link(rel='stylesheet', href='/stylesheets/style.css')        
    link(rel='stylesheet', href='https://maxcdn.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css')
    link(rel="stylesheet",href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css")
    link(rel='stylesheet', href='https://cdnjs.cloudflare.com/ajax/libs/open-iconic/1.1.0/font/css/open-iconic-bootstrap.min.css')
    link(rel='stylesheet', href='https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/4.17.47/css/bootstrap-datetimepicker.min.css')  
    link(id="favicon" rel="shortcut icon" type="image/png" href="/images/mc_logo.jpg" src="/images/mc_logo.jpg")
    link(rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.10.0/font/bootstrap-icons.min.css")
    script(src='https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js')
    script(src='https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.9.0/moment.min.js')
    script(src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js")        
    script(src='https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.3/umd/popper.min.js')
    script(src='https://maxcdn.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js')
    script(src='https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/4.17.47/js/bootstrap-datetimepicker.min.js')
    script(src='https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js')
    script(src='/javascripts/app-validator.js')
    script(src='/javascripts/app-scripts.js')
    script(src='/javascripts/app-master-page-scripts.js')
    script(src='/javascripts/draft-edit-scripts.js')        
    script(src='/javascripts/app-generate-pdf.js', defer)
    script(src='/javascripts/app-report-date.js', defer)
    script(src='/javascripts/app-report-table-generator.js')
    
    style.
      @media print {
        table.table-bordered {
          border-collapse: collapse !important;
        }
        table.table-bordered,
        table.table-bordered th,
        table.table-bordered td {
          border: 1px solid #000 !important;
        }
      }

  - var isFreezedRecord = false;
  if (closingData && closingData.closingStatus === 'CLOSED')
    - isFreezedRecord = true;

  body(onload='populateSummaryFn(' + isFreezedRecord +');')
    
    if user
      div#ajax-loading.d-sm-none
        img#loading-image(src="/images/ajax-loader.gif", alt="Loading...", width="300px", height="300px")

      // Vertical Sidebar
      nav.sidebar#sidebar
        .sidebar-header
          a.sidebar-logo(href="/") PetroMath
          .sidebar-user
            | Logged in as #{user.Person_Name}
            br
            | Location: #{user.location_code}
            if APP_VERSION === 'canary'
              br
              span(style='background-color: orange; color: white; font-size: 0.6rem; padding: 1px 3px; border-radius: 2px;') CANARY

        // Group menus by categories
        - var dropdownGroups = {}
        - var standaloneMenus = []
        each m in user.menuDetails
          if m.parent_code
            - dropdownGroups[m.parent_code] = dropdownGroups[m.parent_code] || []
            - dropdownGroups[m.parent_code].push(m)

        each menu in user.menuDetails
          if !menu.parent_code
            - var children = dropdownGroups[menu.menu_code] || []
            if children.length === 0
              - standaloneMenus.push(menu)

        // Daily Operations Section
        - var dailyOps = standaloneMenus.filter(m => ['Shift Closing', 'Day Close', 'Tank Entry', 'Tank Dip Entry'].includes(m.menu_name))
        if dailyOps.length > 0
          .menu-section
            .menu-section-title Daily Operations
            each menu in dailyOps
              a.menu-item(href=menu.url_path, class=(title === menu.menu_name ? 'active' : ''))
                span.menu-item-icon
                  if menu.menu_name === 'Shift Closing'
                    i.bi.bi-clock
                  else if menu.menu_name === 'Day Close'
                    i.bi.bi-sunrise
                  else if menu.menu_name === 'Tank Entry'
                    i.bi.bi-fuel-pump
                  else if menu.menu_name === 'Tank Dip Entry'
                    i.bi.bi-rulers
                  else
                    i.bi.bi-circle
                | #{menu.menu_name}

        // Transactions Section
        - var transactions = standaloneMenus.filter(m => ['Credit Receipts', 'Tank Receipts', 'Bank Transaction', 'Purchase Invoice'].includes(m.menu_name))
        if transactions.length > 0
          .menu-section
            .menu-section-title Transactions
            each menu in transactions
              a.menu-item(href=menu.url_path, class=(title === menu.menu_name ? 'active' : ''))
                span.menu-item-icon
                  if menu.menu_name === 'Credit Receipts'
                    i.bi.bi-credit-card
                  else if menu.menu_name === 'Tank Receipts'
                    i.bi.bi-receipt
                  else if menu.menu_name === 'Bank Transaction'
                    i.bi.bi-bank
                  else if menu.menu_name === 'Purchase Invoice'
                    i.bi.bi-file-earmark-text
                  else
                    i.bi.bi-circle
                | #{menu.menu_name}

        // Reports & Analytics Section
        - var reports = standaloneMenus.filter(m => ['Reports', 'Utilities'].includes(m.menu_name))
        if reports.length > 0
          .menu-section
            .menu-section-title Reports & Analytics
            each menu in reports
              a.menu-item(href=menu.url_path, class=(title === menu.menu_name ? 'active' : ''))
                span.menu-item-icon
                  if menu.menu_name === 'Reports'
                    i.bi.bi-graph-up
                  else if menu.menu_name === 'Utilities'
                    i.bi.bi-tools
                  else
                    i.bi.bi-circle
                | #{menu.menu_name}

        // Dropdown Menus as Sections
        each menu in user.menuDetails
          if !menu.parent_code
            - var children = dropdownGroups[menu.menu_code] || []
            if children.length > 0
              .menu-section
                .menu-section-title= menu.menu_name
                each child in children
                  a.menu-item(href=child.url_path, class=(title === child.menu_name ? 'active' : ''))
                    span.menu-item-icon
                      i.bi.bi-circle
                    | #{child.menu_name}

        // Administration Section (remaining menus)
        - var adminMenus = standaloneMenus.filter(m => !['Shift Closing', 'Day Close', 'Tank Entry', 'Tank Dip Entry', 'Credit Receipts', 'Tank Receipts', 'Bank Transaction', 'Purchase Invoice', 'Reports', 'Utilities'].includes(m.menu_name))
        if adminMenus.length > 0
          .menu-section
            .menu-section-title Administration
            each menu in adminMenus
              a.menu-item(href=menu.url_path, class=(title === menu.menu_name ? 'active' : ''))
                span.menu-item-icon
                  i.bi.bi-gear
                | #{menu.menu_name}

      // Main Content Area
      .main-content#mainContent
        .top-bar
          .d-flex.align-items-center
            button.sidebar-toggle#sidebarToggle(type="button")
              i.bi.bi-list
            .breadcrumb-nav Dashboard > #{title}
          
          .top-bar-actions
            .user-info
              small Logged in as 
              strong #{user.Person_Name}
            a.logout-btn(href='/logout') Logout

        .content-wrapper
          if messages.error
            .alert.alert-danger #{messages.error}

          if messages.success
            .alert.alert-success #{messages.success}

          if messages.warning
            .alert.alert-warning #{messages.warning}

          div#static-snackbar.alert.alert-danger.d-md-none
          div#snackbar
          
          block content

    else
      // When user is not logged in, show original layout
      h1.text-center#petromath-heading PetroMath
      
      if messages.error
        div &nbsp;
        div.alert.alert-danger #{messages.error}

      if messages.success
        div &nbsp;
        div.alert.alert-success #{messages.success}

      if messages.warning
        div &nbsp;
        div.alert.alert-warning #{messages.warning}

      div &nbsp;
      div#static-snackbar.alert.alert-danger.d-md-none
      div#snackbar
      block content

    script.
      // Sidebar toggle functionality
      document.addEventListener('DOMContentLoaded', function() {
        const sidebarToggle = document.getElementById('sidebarToggle');
        const sidebar = document.getElementById('sidebar');
        const mainContent = document.getElementById('mainContent');
        
        if (sidebarToggle && sidebar && mainContent) {
          sidebarToggle.addEventListener('click', function() {
            if (window.innerWidth <= 768) {
              // Mobile: toggle sidebar visibility
              sidebar.classList.toggle('show');
            } else {
              // Desktop: toggle sidebar collapse
              sidebar.classList.toggle('hidden');
              mainContent.classList.toggle('expanded');
            }
          });

          // Close sidebar when clicking outside on mobile
          document.addEventListener('click', function(event) {
            if (window.innerWidth <= 768 && 
                sidebar.classList.contains('show') &&
                !sidebar.contains(event.target) && 
                !sidebarToggle.contains(event.target)) {
              sidebar.classList.remove('show');
            }
          });

          // Handle window resize
          window.addEventListener('resize', function() {
            if (window.innerWidth > 768) {
              sidebar.classList.remove('show');
            }
          });
        }
      });