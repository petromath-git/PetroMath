extends layout

block content
    div.container(style="max-width:450px; padding: 20px; background: rgba(54, 52, 52, 0.35); border-radius: 10px;")
        h2(style="text-align:center; color: black;") Reset Password
        
        // Show role-based info
        if userRole === 'Admin'
            div.alert.alert-info.text-center
                small Admins can reset: Staff + Customer passwords
        else if userRole === 'Manager'  
            div.alert.alert-warning.text-center
                small Managers can reset: Staff passwords (location rules may apply)
        else if userRole === 'SuperUser'
            div.alert.alert-success.text-center
                small SuperUser: Can reset all passwords globally
        
        div &nbsp;

        // Success message (green)
        if success
            div.alert.alert-success(style="white-space: pre-line;") #{success}

        // Error message (red)  
        if message
            div.alert.alert-danger #{message}

        form(method="POST" action="/password/reset")
            // Add search functionality
            div.form-group
                label(for="userSearch") Search Users:
                input#userSearch.form-control(type="text" placeholder="Type name, username, or role to search..." onkeyup="filterUsers()" autocomplete="off")
                small.text-muted Search by name, username, or role (e.g., "Customer", "Cashier")

            div.form-group
                label(for="username") Select User:
                select#username.form-control(name="username", required, size="8", style="height: auto;",autocomplete="off")
                    option(value="") -- Select a user first --
                    each user in users
                        option(value=user.Person_id, data-searchtext=(user.fullName + " " + user.Role).toLowerCase()) #{user.fullName}

            div.form-group
                label(for="new-password") New Password:
                input#new-password.form-control(type="password" placeholder="Enter new password" required name="newPassword" autocomplete="new-password")

            div.form-group
                label(for="confirm-password") Confirm New Password:
                input#confirm-password.form-control(type="password" placeholder="Confirm new password" required name="confirmPassword" autocomplete="new-password")

            // Quick reset button for customers
            div.form-group.text-center
                button.btn.btn-sm.btn-outline-warning(type="button" onclick="setWelcomePassword()")
                    i.fa.fa-magic
                    | Quick Reset to "welcome123"

            div &nbsp;
            div(style="text-align:center")
                button.btn.btn-primary(type="submit") Reset Password

        br
        div(style="text-align:center")
            a(href="/" class="btn btn-secondary" style="margin-right: 10px;") Cancel            
            a(href="/" class="btn btn-secondary") Back to Home

    script.
        // Clear form after successful reset to allow another reset
        if (#{success ? 'true' : 'false'}) {
            document.addEventListener('DOMContentLoaded', function() {
                document.getElementById('username').value = '';
                document.getElementById('new-password').value = '';
                document.getElementById('confirm-password').value = '';
                document.getElementById('userSearch').value = '';
                document.getElementById('userSearch').focus();
            });
        }

        // Filter users based on search input
        function filterUsers() {
            const searchTerm = document.getElementById('userSearch').value.toLowerCase();
            const select = document.getElementById('username');
            const options = select.getElementsByTagName('option');
            let visibleCount = 0;
            
            for (let i = 1; i < options.length; i++) {
                const option = options[i];
                const searchText = option.getAttribute('data-searchtext') || option.textContent.toLowerCase();
                
                if (searchText.includes(searchTerm) || searchTerm === '') {
                    option.style.display = '';
                    visibleCount++;
                } else {
                    option.style.display = 'none';
                }
            }
            
            const firstOption = options[0];
            if (searchTerm === '') {
                firstOption.textContent = '-- Select a user first --';
            } else {
                firstOption.textContent = `-- ${visibleCount} users found --`;
            }
        }

        // Quick function to set welcome123 password
        function setWelcomePassword() {
            document.getElementById('new-password').value = 'welcome123';
            document.getElementById('confirm-password').value = 'welcome123';
        }

        // Auto-focus search when page loads
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('userSearch').focus();
        });

        // Allow Enter key to move from search to dropdown
        document.getElementById('userSearch').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                const select = document.getElementById('username');
                const visibleOptions = Array.from(select.options).filter(opt => opt.style.display !== 'none' && opt.value !== '');
                if (visibleOptions.length === 1) {
                    select.value = visibleOptions[0].value;
                }
                select.focus();
            }
        });