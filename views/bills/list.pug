extends ../layout

block content
   .container-fluid
    .card
        .card-header
            .d-flex.justify-content-between.align-items-center
                h5.card-title.mb-0 Bills List
                .ml-auto
                    button.btn.btn-primary#cashBillBtn(type='button')
                        i.bi.bi-cash
                        |  Create Cash Bill
                    button.btn.btn-secondary(style='margin-left: 8px;')#creditBillBtn(type='button')
                        i.bi.bi-credit-card
                        |  Create Credit Bill
        
        .card-body
            // Add this search row
            .row.mb-3
                .col-md-2
                    .form-group
                        label(for='billNoSearch') Bill No
                        input#billNoSearch.form-control(type='text' placeholder='Search Bill No')
                .col-md-2
                    .form-group
                        label(for='shiftSearch') Shift
                        select#shiftSearch.form-control
                            option(value='') All Shifts
                            each shift in shifts
                                option(value=shift.closing_id)= shift.shift_display        
                .col-md-2
                    .form-group
                        label(for='billTypeSearch') Bill Type
                        select#billTypeSearch.form-control
                            option(value='') All Types
                            option(value='CASH') Cash
                            option(value='CREDIT') Credit
                            option(value='DIGITAL') Digital
                .col-md-2
                    .form-group
                        label(for='billStatusSearch') Status
                        select#billStatusSearch.form-control
                            option(value='') All Status
                            option(value='DRAFT') Draft
                            option(value='ACTIVE') Active
                            option(value='CANCELLED') Cancelled
                .col-md-2
                    .form-group
                        label(for='dateSearch') Date
                        input#dateSearch.form-control(type='date')
            .table-responsive
                table.table.table-bordered.table-hover
                    thead.thead-light
                        tr
                            th.text-center 
                                i.bi.bi-arrows-expand
                            th Bill No
                            th Type
                            th Customer
                            th.text-right Amount
                            th Status
                            th.text-center Print Count
                            th Cashier
                            th Created Date
                            th.text-center Actions
                    tbody
                        each bill in bills                            
                            tr
                                td.text-center
                                    button.btn.btn-sm.btn-link.expand-row(data-bill-id=bill.bill_id type='button')
                                        i.bi.bi-plus-circle
                                td
                                    if bill.bill_status === 'DRAFT'
                                        a(href=`/bills/edit/${bill.bill_id}` 
                                        class="text-primary hover:text-blue-700" 
                                        title=`Bill ID: ${bill.bill_id}`) #{bill.bill_no}
                                    else
                                        span(title=`Bill ID: ${bill.bill_id}`) #{bill.bill_no}
                                td= bill.bill_type
                                td= bill.customer_name || ''
                                td.text-right= parseFloat(bill.total_amount || 0).toFixed(2)
                                td(class=bill.bill_status === 'CANCELLED' ? 'text-danger fw-bold' : '')= bill.bill_status
                                td.text-center= bill.print_count
                                td= bill.cashier_name
                                td= new Date(bill.creation_date).toLocaleDateString('en-IN')
                                td.text-center
                                    div.d-flex.gap-2
                                        if bill.bill_status !== 'CANCELLED'
                                            button.btn.btn-info.btn-sm.ms-4(
                                                type='button' 
                                                onClick='generatePDF(window.location.href, "Y")', 
                                                id="printButton", 
                                                data-bill-id=bill.bill_id
                                                title="Print Bill"
                                            )
                                                i.bi.bi-printer
                                        if bill.bill_status === 'DRAFT'
                                            button.btn.btn-danger.btn-sm.delete-bill.ms-4(
                                                type='button'
                                                data-bill-id=bill.bill_id
                                                title="Delete Bill"
                                            )
                                                i.bi.bi-trash
                                        else if bill.bill_status === 'ACTIVE' && bill.closing_status === 'DRAFT'
                                            button.btn.btn-warning.btn-sm.cancel-bill.ms-4(
                                                type='button'
                                                data-bill-id=bill.bill_id
                                                title="Cancel Bill"
                                            )
                                                i.bi.bi-x-circle
                            // Expandable detail row
                            tr.bill-details(id=`details-${bill.bill_id}` style='display: none;')
                                td(colspan='10')
                                    .bill-details-content(id=`content-${bill.bill_id}`)
                                        .text-center
                                            i.bi.bi-hourglass.spin
                                            |  Loading...
    script.
        $(document).ready(function() {

            $('#cashBillBtn, #creditBillBtn').click(function(e) {
                    e.preventDefault();
                    const clickedButton = $(this);

                    // First check for draft shifts
                    $.get('/bills/check-draft-shifts')
                        .then(function(shiftResponse) {
                            if (!shiftResponse.hasDraftShifts) {
                                alert('No open shifts available. Please create a new shift first.\n\nதிறந்த ஷிப்ட் இல்லை. முதலில் புதிய ஷிப்ட் உருவாக்கவும்.');
                                return Promise.reject('No open shifts');
                            }
                            
                            // If shifts exist, then check for draft bills
                            return $.get('/bills/check-drafts');
                        })
                        .then(function(draftResponse) {
                            if (draftResponse.hasDrafts) {
                                const draftDetails = draftResponse.draftBills.map(bill => 
                                    `Bill ${bill.bill_no} (Cashier: ${bill.cashier_name})`
                                ).join('\n');

                                alert(`${draftDetails}\n\nPlease complete or delete existing draft bills before creating a new one.\n\nபுதிய பில் உருவாக்குவதற்கு முன், நிலுவையில் உள்ள பில்களை முடிக்கவும் அல்லது நீக்கவும்`);
                                return Promise.reject('Draft bills exist');
                            }
                            
                            // If all checks pass, proceed to create bill
                            const billType = clickedButton.attr('id') === 'cashBillBtn' ? 'CASH' : 'CREDIT';
                            window.location.href = `/bills/new?type=${billType}`;
                        })
                        .fail(function(error) {
                            if (error === 'No open shifts' || error === 'Draft bills exist') {
                                return; // Already showed alert
                            }
                            console.error('Error during checks:', error);
                            alert('Error checking shifts and drafts. Please try again.');
                        });
                });


            //-   $('#cashBillBtn, #creditBillBtn').click(function(e) {
            //-     e.preventDefault();
                
            //-     // Check for draft shifts
            //-     $.get('/bills/check-draft-shifts', function(response) {
            //-         if (!response.hasDraftShifts) {
            //-             alert('No open shifts available. Please create a new shift first.');
            //-         } else {
            //-             // Determine bill type based on which button was clicked
            //-                     const billType = clickedButton.attr('id') === 'cashBillBtn' ? 'CASH' : 'CREDIT';
            //-                     window.location.href = `/bills/new?type=${billType}`;
            //-         }
            //-     }).fail(function(error) {
            //-         console.error('Error checking draft Shifts:', error);
            //-         alert('Error checking draft Shifts. Please try again.');
            //-     });
            //- });
 
            $('.expand-row').click(function() {
                const billId = $(this).data('bill-id');
                const detailsRow = $(`#details-${billId}`);
                const icon = $(this).find('i');
                
                if (detailsRow.is(':visible')) {
                    detailsRow.hide();
                    icon.removeClass('bi-dash-circle').addClass('bi-plus-circle');
                } else {
                    detailsRow.show();
                    icon.removeClass('bi-plus-circle').addClass('bi-dash-circle');
                    
                    // Only load content if not already loaded
                    if ($(`#content-${billId}`).html().includes('Loading')) {
                        $.get(`/bills/${billId}/details`, function(data) {
                            const content = `
                                <div class="container-fluid mt-3 mb-3">
                                    <div class="row">
                                        <div class="col-md-12">
                                            <table class="table table-sm table-bordered">
                                                <thead class="thead-light">
                                                    <tr>
                                                        <th>Product</th>
                                                        <th class="text-right">Price</th>
                                                        <th class="text-right">Quantity</th>
                                                        <th class="text-right">Discount</th>
                                                        <th class="text-right">Amount</th>
                                                        <th>Notes</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    ${data.items.map(item => `
                                                        <tr>
                                                            <td>${item.product_name}</td>
                                                            <td class="text-right">${parseFloat(item.price).toFixed(2)}</td>
                                                            <td class="text-right">${parseFloat(item.qty).toFixed(3)}</td>
                                                            <td class="text-right">${parseFloat(item.price_discount || 0).toFixed(2)}</td>
                                                            <td class="text-right">${parseFloat(item.amount).toFixed(2)}</td>
                                                            <td>${item.notes || ''}</td>
                                                        </tr>
                                                    `).join('')}
                                                </tbody>
                                                ${data.bill_type === 'CREDIT' ? `
                                                    <tfoot>
                                                        <tr>
                                                            <td colspan="6">
                                                                ${data.vehicle_number ? `<strong>Vehicle:</strong> ${data.vehicle_number}` : ''}
                                                                ${data.indent_number ? `<br><strong>Indent:</strong> ${data.indent_number}` : ''}
                                                            </td>
                                                        </tr>
                                                    </tfoot>
                                                ` : ''}
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            `;
                            $(`#content-${billId}`).html(content);
                        });
                    }
                }
            });

             $('.delete-bill').each(function() {
                $(this).on('click', function() {
                    const billId = $(this).data('bill-id');
                    
                    if (confirm('Are you sure you want to delete this bill? This action cannot be undone.')) {
                        fetch(`/bills/${billId}`, {
                            method: 'DELETE'
                        }).then(response => {
                            if (response.redirected) {
                                window.location.href = response.url;
                            }
                        }).catch(error => {
                            console.error('Delete error:', error);
                            alert('An error occurred while deleting the bill.');
                        });
                    }
                });
            });          

       
            function filterTable() {
                const billNo = $('#billNoSearch').val().toLowerCase();
                const shift = $('#shiftSearch').val();  // Now gets the closing_id value
                const billType = $('#billTypeSearch').val();
                const billStatus = $('#billStatusSearch').val();
                const searchDate = $('#dateSearch').val();

                $('.table tbody tr:not(.bill-details)').each(function() {
                    const $row = $(this);
                    const rowBillNo = $row.find('td:eq(1)').text().toLowerCase();
                    const rowShift = $row.find('td:eq(7)').text().match(/\((\d+)\)/)?.[1] || '';
                    const rowType = $row.find('td:eq(2)').text();
                    const rowStatus = $row.find('td:eq(5)').text();
                    
                    const dateStr = $row.find('td:eq(8)').text();
                    const [day, month, year] = dateStr.split('/');
                    const rowDate = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;

                    const matchesBillNo = !billNo || rowBillNo.includes(billNo);
                    const matchesShift = !shift || rowShift === shift;
                    const matchesType = !billType || rowType === billType;
                    const matchesStatus = !billStatus || rowStatus === billStatus;
                    const matchesDate = !searchDate || rowDate === searchDate;

                    if (matchesBillNo && matchesShift && matchesType && matchesStatus && matchesDate) {
                        $row.show();
                    } else {
                        $row.hide();
                        $(`#details-${$row.find('.expand-row').data('bill-id')}`).hide();
                    }
                });
            }


            // Attach event listeners to search inputs
            $('#billNoSearch, #shiftSearch, #billTypeSearch, #billStatusSearch, #dateSearch').on('input change', filterTable);

                // Cancel Bill functionality
                // Cancel Bill functionality
                $('.cancel-bill').click(function() {
                    const billId = $(this).data('bill-id');
                    
                    // Create modal for reason input
                    const modalHtml = `
                        <div class="modal fade" id="cancelBillModal" tabindex="-1">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title">Cancel Bill</h5>
                                        <button type="button" class="btn-close" data-dismiss="modal" aria-label="Close"></button>
                                    </div>
                                    <div class="modal-body">
                                        <div class="form-group">
                                            <label for="cancelReason">Cancellation Reason *</label>
                                            <textarea id="cancelReason" class="form-control" rows="3" required></textarea>
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                                        <button type="button" class="btn btn-warning" id="confirmCancel">Cancel Bill</button>
                                    </div>
                                </div>
                            </div>
                        </div>`;

                    // Add modal to body if it doesn't exist
                    if (!$('#cancelBillModal').length) {
                        $('body').append(modalHtml);
                    }

                    // Show modal
                    $('#cancelBillModal').modal('show');

                    // Handle confirmation
                    $('#confirmCancel').off('click').on('click', function() {
                        const reason = $('#cancelReason').val().trim();
                        
                        if (!reason) {
                            alert('Please provide a cancellation reason');
                            return;
                        }

                        fetch(`/bills/${billId}/cancel`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ reason: reason })
                        }).then(response => {
                            if (response.redirected) {
                                window.location.href = response.url;
                            } else {
                                response.json().then(data => {
                                    if (data.success) {
                                        location.reload();
                                    } else {
                                        alert(data.error || 'Failed to cancel bill');
                                    }
                                }).catch(() => {
                                    location.reload(); // Reload if we can't parse JSON response
                                });
                            }
                        }).catch(error => {
                            console.error('Cancel error:', error);
                            alert('An error occurred while cancelling the bill');
                        });

                        $('#cancelBillModal').modal('hide');
                    });
                });
              
        });